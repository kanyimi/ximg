{% load i18n %}

<div class="dash-card">
  <div class="dash-card-head">
    <form id="notesSearchForm" class="dash-search">
      <input type="text" name="q" value="{{ q }}" placeholder="Search by note id...">
      <button class="dash-btn" type="submit">{% translate "Search" %}</button>
    </form>
  </div>

  <!-- Tabs -->
  <div class="dash-tabs" role="tablist" aria-label="Secret Notes Tabs">
    <button class="dash-tab {% if tab == 'active' %}is-active{% endif %}"
            type="button"
            role="tab"
            aria-selected="{% if tab == 'active' %}true{% else %}false{% endif %}"
            aria-controls="tab-active"
            id="tab-active-btn">
      {% translate "Active notes" %}
      <span class="dash-tab-badge">{{ notes_page.paginator.count }}</span>
    </button>

    <button class="dash-tab {% if tab == 'retention' %}is-active{% endif %}"
            type="button"
            role="tab"
            aria-selected="{% if tab == 'retention' %}true{% else %}false{% endif %}"
            aria-controls="tab-retention"
            id="tab-retention-btn">
      {% translate "Retention copies" %}
      <span class="dash-tab-badge">{{ retention_page.paginator.count }}</span>
    </button>

    <button class="dash-tab {% if tab == 'flagged' %}is-active{% endif %}"
            type="button"
            role="tab"
            aria-selected="{% if tab == 'flagged' %}true{% else %}false{% endif %}"
            aria-controls="tab-flagged"
            id="tab-flagged-btn">
      {% translate "Flagged notes" %}
      <span class="dash-tab-badge">{{ flagged_page.paginator.count }}</span>
    </button>
  </div>

  <!-- Panels -->
  <div class="dash-tabpanes">

    <!-- Active -->
    <section id="tab-active"
             class="dash-tabpane {% if tab == 'active' %}is-active{% endif %}"
             role="tabpanel"
             aria-labelledby="tab-active-btn">

      <div class="dash-table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th>{% translate "ID" %}</th>
              <th>{% translate "Created" %}</th>
              <th>{% translate "Expires" %}</th>
              <th>{% translate "Delete after read" %}</th>
              <th>{% translate "Password" %}</th>
              <th>{% translate "Open" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for n in notes %}
              <tr>
                <td><code>{{ n.id }}</code></td>
                <td>{{ n.created_at|date:"d.m.Y" }}</td>
                <td>
                  {% if n.expires_at %}
                    {{ n.expires_at|date:"d.m.Y" }}
                  {% else %}
                    <span class="dash-muted">{% translate "Delete after reading" %}</span>
                  {% endif %}
                </td>
                <td>
                  {% if n.delete_after_read %}{% translate "Yes" %}{% else %}{% translate "No" %}{% endif %}
                </td>
                <td>
                  {% if n.has_password %}{% translate "Yes" %}{% else %}{% translate "No" %}{% endif %}
                </td>
                <td>
                  <a class="dash-link-small"
                     href="{% url 'secret_notes:view' note_id=n.id %}"
                     target="_blank" rel="noopener">
                    <i class="fa fa-eye" style="font-size:40px;color:#227851;"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="dash-muted">{% translate "No active notes found." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination: Active #}
      {% with p=notes_page %}
        {% if p.paginator.num_pages > 1 %}
          <div class="dash-pager" data-tab="active">
            <div class="dash-pager-left">
              {% if p.has_previous %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=active&page_active=1&page_retention={{ retention_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=active&page_active={{ p.previous_page_number }}&page_retention={{ retention_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>

            <div class="dash-pager-mid">
              Page <strong>{{ p.number }}</strong> of <strong>{{ p.paginator.num_pages }}</strong>
              <span class="dash-muted">({{ p.paginator.count }} notes)</span>
            </div>

            <div class="dash-pager-right">
              {% if p.has_next %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=active&page_active={{ p.next_page_number }}&page_retention={{ retention_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=active&page_active={{ p.paginator.num_pages }}&page_retention={{ retention_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
    </section>

    <!-- Retention -->
    <section id="tab-retention"
             class="dash-tabpane {% if tab == 'retention' %}is-active{% endif %}"
             role="tabpanel"
             aria-labelledby="tab-retention-btn">

      <div class="dash-table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th>{% translate "Note ID" %}</th>
              <th>{% translate "Created" %}</th>
              <th>{% translate "Expires" %}</th>
              <th>{% translate "Had password" %}</th>
              <th>{% translate "Preview" %}</th>
              <th>{% translate "View" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in retention_rows %}
              <tr>
                <td><code>{{ r.note_id }}</code></td>
                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                <td>{{ r.expires_at|date:"d.m.Y" }}</td>
                <td>
                  {% if r.had_password %}{% translate "Yes" %}{% else %}{% translate "No" %}{% endif %}
                </td>
                <td style="max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                    title="{{ r.preview }}">
                  {{ r.preview }}
                </td>
                <td>
                  <button type="button"
                          class="dash-btn dash-btn-secondary js-view-note"
                          data-note-id="{{ r.note_id }}"
                          data-plaintext="{{ r.plaintext|escapejs }}">
                    {% translate "View" %}
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="dash-muted">{% translate "No retention copies found." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination: Retention #}
      {% with p=retention_page %}
        {% if p.paginator.num_pages > 1 %}
          <div class="dash-pager" data-tab="retention">
            <div class="dash-pager-left">
              {% if p.has_previous %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=retention&page_retention=1&page_active={{ notes_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=retention&page_retention={{ p.previous_page_number }}&page_active={{ notes_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>

            <div class="dash-pager-mid">
              Page <strong>{{ p.number }}</strong> of <strong>{{ p.paginator.num_pages }}</strong>
              <span class="dash-muted">({{ p.paginator.count }} retention)</span>
            </div>

            <div class="dash-pager-right">
              {% if p.has_next %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=retention&page_retention={{ p.next_page_number }}&page_active={{ notes_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=retention&page_retention={{ p.paginator.num_pages }}&page_active={{ notes_page.number }}&page_flagged={{ flagged_page.number }}"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
    </section>

    <!-- Flagged -->
    <section id="tab-flagged"
             class="dash-tabpane {% if tab == 'flagged' %}is-active{% endif %}"
             role="tabpanel"
             aria-labelledby="tab-flagged-btn">

      <div class="dash-table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th>{% translate "Note ID" %}</th>
              <th>{% translate "Created" %}</th>
              <th>{% translate "Matched terms" %}</th>
              <th>{% translate "Preview" %}</th>
              <th>{% translate "View" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for f in flagged_rows %}
              <tr>
                <td><code>{{ f.note_id }}</code></td>
                <td>{{ f.created_at|date:"d.m.Y" }}</td>
                <td>{{ f.matched_terms }}</td>
                <td style="max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                    title="{{ f.preview }}">
                  {{ f.preview }}
                </td>
                <td>
                  <button type="button"
                          class="dash-btn dash-btn-secondary js-view-note"
                          data-note-id="{{ f.note_id }}"
                          data-plaintext="{{ f.plaintext|escapejs }}">
                    {% translate "View" %}
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="dash-muted">{% translate "No flagged notes found." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# Pagination: Flagged #}
      {% with p=flagged_page %}
        {% if p.paginator.num_pages > 1 %}
          <div class="dash-pager" data-tab="flagged">
            <div class="dash-pager-left">
              {% if p.has_previous %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=flagged&page_flagged=1&page_active={{ notes_page.number }}&page_retention={{ retention_page.number }}"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=flagged&page_flagged={{ p.previous_page_number }}&page_active={{ notes_page.number }}&page_retention={{ retention_page.number }}"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-left" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-left" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>

            <div class="dash-pager-mid">
              Page <strong>{{ p.number }}</strong> of <strong>{{ p.paginator.num_pages }}</strong>
              <span class="dash-muted">({{ p.paginator.count }} flagged)</span>
            </div>

            <div class="dash-pager-right">
              {% if p.has_next %}
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=flagged&page_flagged={{ p.next_page_number }}&page_active={{ notes_page.number }}&page_retention={{ retention_page.number }}"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></a>
                <a class="dash-pager-btn"
                   href="?q={{ q|urlencode }}&tab=flagged&page_flagged={{ p.paginator.num_pages }}&page_active={{ notes_page.number }}&page_retention={{ retention_page.number }}"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></a>
              {% else %}
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-right" style="font-size:24px;color:#227851;"></i></span>
                <span class="dash-pager-btn is-disabled"><i class="fa fa-angle-double-right" style="font-size:24px;color:#227851;"></i></span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
    </section>

  </div>
</div>

<!-- Modal (unchanged) -->
<div class="dash-modal" id="retentionModal" aria-hidden="true">
  <div class="dash-modal__overlay" data-close="1"></div>

  <div class="dash-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="retentionModalTitle">
    <div class="dash-modal__head">
      <div>
        <div class="dash-modal__title" id="retentionModalTitle">{% translate "Retention Note" %}</div>
        <div class="dash-modal__subtitle">{% translate "Note ID:" %} <code id="retentionModalId"></code></div>
      </div>

      <button type="button" class="dash-modal__close" aria-label="Close" data-close="1">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="dash-modal__body">
      <textarea id="retentionModalText" readonly></textarea>
    </div>

    <div class="dash-modal__foot">
      <button type="button" class="dash-btn" id="retentionCopyBtn">
        <i class="fa-regular fa-copy"></i> {% translate "Copy" %}
      </button>
      <button type="button" class="dash-btn" data-close="1">{% translate "Close" %}</button>
    </div>
  </div>
</div>
