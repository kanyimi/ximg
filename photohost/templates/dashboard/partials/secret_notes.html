{% load i18n %}
<div class="dash-card">
  <div class="dash-card-head">

    <form id="notesSearchForm" class="dash-search">
      <input type="text" name="q" value="{{ q }}" placeholder="Search by note id...">
      <button class="dash-btn" type="submit">{% translate "Search" %}</button>
    </form>
  </div>

  <!-- Tabs -->
  <div class="dash-tabs" role="tablist" aria-label="Secret Notes Tabs">
    <button class="dash-tab is-active"
            type="button"
            role="tab"
            aria-selected="true"
            aria-controls="tab-active"
            id="tab-active-btn">
     {% translate "Active notes" %}
      <span class="dash-tab-badge">{{ notes|length }}</span>
    </button>

    <button class="dash-tab"
            type="button"
            role="tab"
            aria-selected="false"
            aria-controls="tab-retention"
            id="tab-retention-btn">
      {% translate "Retention copies" %}
      <span class="dash-tab-badge">{{ retention_rows|length }}</span>
    </button>
    <button class="dash-tab"
        type="button"
        role="tab"
        aria-selected="false"
        aria-controls="tab-flagged"
        id="tab-flagged-btn">
  {% translate "Flagged notes" %}
  <span class="dash-tab-badge">{{ flagged_rows|length }}</span>
</button>

  </div>

  <!-- Panels -->
  <div class="dash-tabpanes">
    <!-- Active -->
    <section id="tab-active"
             class="dash-tabpane is-active"
             role="tabpanel"
             aria-labelledby="tab-active-btn">

      <div class="dash-table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th>{% translate "ID" %}</th>
              <th>{% translate "Created" %}</th>
              <th>{% translate "Expires" %}</th>
              <th>{% translate "Delete after read" %}</th>
              <th>{% translate "Password" %}</th>
              <th>{% translate "Open" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for n in notes %}
              <tr>
                <td><code>{{ n.id }}</code></td>
                <td>{{ n.created_at }}</td>
                <td>
                  {% if n.expires_at %}
                    {{ n.expires_at }}
                  {% else %}
                    <span class="dash-muted">{% translate "Delete after reading" %}</span>
                  {% endif %}
                </td>
                <td>{% if n.delete_after_read %}
                  {% translate "Yes" %}
                  {% else %}
                  {% translate "No" %}
                  {% endif %}</td>
                <td>{% if n.has_password %}
                  {% translate "Yes" %}
                  {% else %}
                  {% translate "No" %}
                  {% endif %}</td>
                <td>
                  <a class="dash-link-small"
                     href="{% url 'secret_notes:view' note_id=n.id %}"
                     target="_blank" rel="noopener">
                    <i class="fa fa-eye" style="font-size:40px;color:#227851;"></i>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="dash-muted">{% translate "No active notes found." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Retention -->
    <section id="tab-retention"
             class="dash-tabpane"
             role="tabpanel"
             aria-labelledby="tab-retention-btn">

      <div class="dash-table-wrap">
        <table class="dash-table">
          <thead>
            <tr>
              <th>{% translate "Note ID" %}</th>
              <th>{% translate "Created" %}</th>
              <th>{% translate "Expires" %}</th>
              <th>{% translate "Had password" %}</th>
              <th>{% translate "Preview" %}</th>
              <th>{% translate "View" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in retention_rows %}
              <tr>
                <td><code>{{ r.note_id }}</code></td>
                <td>{{ r.created_at }}</td>
                <td>{{ r.expires_at }}</td>
                <td>{% if r.had_password %}
                  {% translate "Yes" %}
                  {% else %}
                  {% translate "No" %}
                  {% endif %}</td>

                <td style="max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                    title="{{ r.preview }}">
                  {{ r.preview }}
                </td>

                <td>
                  <button type="button"
                          class="dash-btn dash-btn-secondary js-view-note"
                          data-note-id="{{ r.note_id }}"
                          data-plaintext="{{ r.plaintext|escapejs }}">
                    {% translate "View" %}
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="dash-muted">{% translate "No retention copies found." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <!-- Flagged -->
<section id="tab-flagged"
         class="dash-tabpane"
         role="tabpanel"
         aria-labelledby="tab-flagged-btn">

  <div class="dash-table-wrap">
    <table class="dash-table">
      <thead>
        <tr>
          <th>{% translate "Note ID" %}</th>
          <th>{% translate "Created" %}</th>
          <th>{% translate "Matched terms" %}</th>
          <th>{% translate "Preview" %}</th>
          <th>{% translate "View" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for f in flagged_rows %}
          <tr>
            <td><code>{{ f.note_id }}</code></td>
            <td>{{ f.created_at }}</td>
            <td>{{ f.matched_terms }}</td>

            <td style="max-width: 360px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                title="{{ f.preview }}">
              {{ f.preview }}
            </td>

            <td>
              <button type="button"
                      class="dash-btn dash-btn-secondary js-view-note"
                      data-note-id="{{ f.note_id }}"
                      data-plaintext="{{ f.plaintext|escapejs }}">
                {% translate "View" %}
              </button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="dash-muted">{% translate "No flagged notes found." %}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

  </div>
</div>

<!-- Modal (unchanged) -->
<div class="dash-modal" id="retentionModal" aria-hidden="true">
  <div class="dash-modal__overlay" data-close="1"></div>

  <div class="dash-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="retentionModalTitle">
    <div class="dash-modal__head">
      <div>
        <div class="dash-modal__title" id="retentionModalTitle">{% translate "Retention Note" %}</div>
        <div class="dash-modal__subtitle">{% translate "Note ID:" %} <code id="retentionModalId"></code></div>
      </div>

      <button type="button" class="dash-modal__close" aria-label="Close" data-close="1">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="dash-modal__body">
      <textarea id="retentionModalText" readonly></textarea>
    </div>

    <div class="dash-modal__foot">
      <button type="button" class="dash-btn" id="retentionCopyBtn">
        <i class="fa-regular fa-copy"></i> {% translate "Copy" %}
      </button>
      <button type="button" class="dash-btn" data-close="1">{% translate "Close" %}</button>
    </div>
  </div>
</div>
